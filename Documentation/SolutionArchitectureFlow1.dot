digraph ResponseRally_SolutionArchitecture {
    rankdir=TB;  /* Keep TB for vertical flow */
    fontname="Helvetica";
    bgcolor="transparent";
    splines=ortho;
    nodesep=0.6;
    ranksep=0.9;
    newrank=true;  /* Allow clusters to participate in ranking */

    node [
        shape=rectangle,
        style="rounded,filled",
        fontname="Helvetica",
        color="#000000"
    ];

    edge [
        color="#000000",
        arrowhead=normal
    ];

    /* ===== Presentation Layer ===== */
    subgraph cluster_ui {
        label="Presentation Layer";
        style="rounded,dashed";
        color="#C7D2FE";
        bgcolor="#F5F7FF";
        rank="min";  /* Force to leftmost position */

        User [
            label="User\n(Developer / Researcher)",
            fillcolor="#E0F2FE"
        ];

        WebUI [
            label="Web UI\n(React)",
            fillcolor="#E0F2FE"
        ];
    }

    /* ===== Application Layer ===== */
    subgraph cluster_app {
        label="Application Layer";
        style="rounded,dashed";
        color="#BBF7D0";
        bgcolor="#F6FFFA";

        BackendAPI [
            label="Backend API\n(Python with Rest-API)",
            fillcolor="#DCFCE7"
        ];

        Orchestrator [
            label="LLM Orchestration Service\n• Fan-Out Logic\n• Async / Promise.all",
            fillcolor="#DCFCE7"
        ];
    }

    /* ===== AI Provider Layer ===== */
    subgraph cluster_ai {
        label="AI Provider Layer";
        style="rounded,dashed";
        color="#FED7AA";
        bgcolor="#FFF8ED";

        GPT [label="GPT API", fillcolor="#FFEDD5"];
        Gemini [label="Gemini API", fillcolor="#FFEDD5"];
        Mistral [label="Mistral API", fillcolor="#FFEDD5"];
        DeepSeek [label="DeepSeek API", fillcolor="#FFEDD5"];
        LLaMa [label="LLaMa API", fillcolor="#FFEDD5"];
        Copilot [label="Copilot API", fillcolor="#FFEDD5"];
    }

    /* ===== Resilience & Processing Layer ===== */
    subgraph cluster_processing {
        label="Resilience & Processing";
        style="rounded,dashed";
        color="#FCA5A5";
        bgcolor="#FFF1F2";

        ErrorHandler [
            label="Error Handling\n• Retry\n• Backoff\n• Timeout\n• Fallback",
            fillcolor="#FECACA"
        ];

        Normalization [
            label="Response Normalization\n+ Metrics Collection\n(Latency, Tokens, Status)",
            fillcolor="#EDE9FE"
        ];
    }

    /* ===== Output Layer ===== */
    subgraph cluster_output {
        label="Output & Evaluation";
        style="rounded,dashed";
        color="#BAE6FD";
        bgcolor="#F0F9FF";
        rank="max";  /* Force to rightmost position */

        Comparison [
            label="Side-by-Side Comparison\n(Partial Results Allowed)",
            fillcolor="#E0F2FE"
        ];

        BestSelection [
            label="Best Response Selection",
            fillcolor="#FDE68A"
        ];
    }

    /* ===== Flow (Ortho Friendly) ===== */
    /* Use invisible edges to enforce ordering while keeping clusters */
    edge [style=invis];
    
    /* Force Presentation Layer to be leftmost */
    cluster_ui -> cluster_app [weight=100];
    cluster_app -> cluster_ai [weight=100];
    cluster_ai -> cluster_processing [weight=100];
    cluster_processing -> cluster_output [weight=100];
    
    /* Reset edge style for actual connections */
    edge [style=solid, constraint=true];
    
    User -> WebUI;
    WebUI -> BackendAPI;
    BackendAPI -> Orchestrator;

    Orchestrator -> GPT;
    Orchestrator -> Gemini;
    Orchestrator -> Mistral;
    Orchestrator -> DeepSeek;
    Orchestrator -> LLaMa;
    Orchestrator -> Copilot;

    GPT -> Normalization;
    Gemini -> Normalization;
    Mistral -> Normalization;
    DeepSeek -> Normalization;
    LLaMa -> Normalization;
    Copilot -> Normalization;

    GPT -> ErrorHandler;
    Gemini -> ErrorHandler;
    Mistral -> ErrorHandler;
    DeepSeek -> ErrorHandler;
    LLaMa -> ErrorHandler;
    Copilot -> ErrorHandler;

    ErrorHandler -> Normalization;

    Normalization -> Comparison;
    Comparison -> BestSelection;
}