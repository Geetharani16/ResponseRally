<!DOCTYPE html>
<html>
<head>
    <title>ResponseRally Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; margin: 0; }
        .container { max-width: 800px; float: left; width: calc(100% - 420px); padding-right: 20px; }
        .raw-panel { width: 380px; float: right; height: 100vh; overflow-y: auto; padding: 15px; background: #f8f9fa; border-left: 1px solid #ddd; position: fixed; right: 0; top: 0; }
        .response { margin: 10px 0; padding: 10px; background: #f5f5f5; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        input { padding: 8px; margin: 5px; width: 300px; }
        #output { margin-top: 20px; }
        .raw-json { background: #fff; border: 1px solid #ddd; padding: 10px; margin: 10px 0; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; white-space: pre-wrap; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ResponseRally Backend Test</h1>
        <p><strong>Server Status:</strong> <span id="status">Checking...</span></p>
        
        <div>
            <button onclick="createSession()">1. Create Session</button>
            <button onclick="getHealth()">Check Health</button>
        </div>
        
        <div id="sessionInfo" style="display:none; margin: 10px 0; padding: 10px; background: #e7f3ff;">
            <strong>Current Session:</strong> <span id="sessionId"></span>
        </div>
        
        <div style="margin: 15px 0;">
            <input type="text" id="promptInput" placeholder="Enter your prompt here..." value="Hello, how are you?">
            <button onclick="sendPrompt()">2. Send Prompt to Mistral</button>
        </div>
        
        <div style="margin: 15px 0;">
            <input type="text" id="sessionIdInput" placeholder="Enter session ID to retrieve">
            <button onclick="getSession()">3. Get Session Details</button>
        </div>
        
        <div id="output"></div>
    </div>

    <div class="raw-panel">
        <h3>Raw JSON Responses</h3>
        <div id="rawOutput"></div>
    </div>

    <script>
        let currentSession = null;
        
        // Check server health
        async function getHealth() {
            try {
                const response = await fetch('http://localhost:5000/health');
                const data = await response.json();
                document.getElementById('status').innerHTML = '<span class="success">✅ Running - ' + data.status + '</span>';
                addRawJson(data, 'Health Response');
            } catch (error) {
                document.getElementById('status').innerHTML = '<span class="error">❌ Not Running - ' + error.message + '</span>';
                console.error('Health check error:', error);
            }
        }
        
        // Create a new session
        async function createSession() {
            try {
                const response = await fetch('http://localhost:5000/api/v1/session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                addRawJson(data, 'Create Session Response');
                currentSession = data;
                document.getElementById('sessionId').textContent = data.id;
                document.getElementById('sessionInfo').style.display = 'block';
                document.getElementById('sessionIdInput').value = data.id;
                
                addOutput(`<div class="response"><strong>✅ Session Created:</strong> ${data.id}</div>`);
            } catch (error) {
                addOutput(`<div class="response"><strong>❌ Error:</strong> ${error.message}</div>`);
                console.error('Create session error:', error);
            }
        }
        
        // Send a prompt to Mistral
        async function sendPrompt() {
            const promptText = document.getElementById('promptInput').value;
            if (!promptText) {
                addOutput('<div class="response"><strong>❌ Error:</strong> Please enter a prompt</div>');
                return;
            }
            
            let sessionId = document.getElementById('sessionIdInput').value;
            if (!sessionId && currentSession) {
                sessionId = currentSession.id;
            }
            
            if (!sessionId) {
                addOutput('<div class="response"><strong>❌ Error:</strong> Please create a session or enter session ID</div>');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:5000/api/v1/prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        prompt: promptText,
                        providers: ["mistral"]
                    })
                });
                const data = await response.json();
                addRawJson(data, 'Prompt Response');
                
                addOutput(`<div class="response"><strong>✅ Prompt Sent:</strong> ${data.currentPrompt}<br>
                <strong>Status:</strong> ${data.currentResponses[0].status}</div>`);
                
                // Check for response after a delay
                setTimeout(() => checkSessionResponse(sessionId), 5000);
            } catch (error) {
                addOutput(`<div class="response"><strong>❌ Error:</strong> ${error.message}</div>`);
                console.error('Send prompt error:', error);
            }
        }
        
        // Get session details
        async function getSession() {
            const sessionId = document.getElementById('sessionIdInput').value;
            if (!sessionId) {
                addOutput('<div class="response"><strong>❌ Error:</strong> Please enter a session ID</div>');
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:5000/api/v1/session/${sessionId}`);
                const data = await response.json();
                addRawJson(data, 'Get Session Response');
                
                let responseInfo = '';
                if (data.currentResponses && data.currentResponses.length > 0) {
                    const response = data.currentResponses[0];
                    responseInfo = `<br><strong>Response:</strong> ${response.response.substring(0, 200)}...<br>
                    <strong>Status:</strong> ${response.status}<br>
                    <strong>Tokens:</strong> ${response.metrics.tokenCount}<br>
                    <strong>Latency:</strong> ${response.metrics.latencyMs}ms`;
                }
                
                addOutput(`<div class="response"><strong>✅ Session Retrieved:</strong> ${data.id}<br>
                <strong>Prompt:</strong> ${data.currentPrompt}<br>${responseInfo}</div>`);
            } catch (error) {
                addOutput(`<div class="response"><strong>❌ Error:</strong> ${error.message}</div>`);
                console.error('Get session error:', error);
            }
        }
        
        // Check for response after sending prompt
        async function checkSessionResponse(sessionId) {
            try {
                const response = await fetch(`http://localhost:5000/api/v1/session/${sessionId}`);
                const data = await response.json();
                addRawJson(data, 'Check Response Status');
                
                if (data.currentResponses && data.currentResponses.length > 0) {
                    const response = data.currentResponses[0];
                    if (response.status === 'success') {
                        addOutput(`<div class="response"><strong>✅ REAL MISTRAL RESPONSE:</strong><br>
                        "${response.response}"<br>
                        <strong>Tokens:</strong> ${response.metrics.tokenCount}, 
                        <strong>Latency:</strong> ${response.metrics.latencyMs}ms</div>`);
                    } else if (response.status === 'error') {
                        addOutput(`<div class="response"><strong>❌ API Error:</strong> ${response.errorMessage}</div>`);
                    } else {
                        addOutput(`<div class="response"><strong>⏳ Still Processing:</strong> ${response.status}</div>`);
                    }
                }
            } catch (error) {
                addOutput(`<div class="response"><strong>❌ Error checking response:</strong> ${error.message}</div>`);
                console.error('Check response error:', error);
            }
        }
        
        function addOutput(content) {
            const outputDiv = document.getElementById('output');
            outputDiv.innerHTML = content + outputDiv.innerHTML;
        }
        
        function addRawJson(jsonData, title) {
            const rawOutputDiv = document.getElementById('rawOutput');
            const rawJsonContent = `<div class="raw-json"><strong>${title}:</strong><br>${JSON.stringify(jsonData, null, 2)}</div>`;
            rawOutputDiv.innerHTML = rawJsonContent + rawOutputDiv.innerHTML;
        }
        
        // Initialize
        window.onload = function() {
            getHealth();
        };
    </script>
</body>
</html>